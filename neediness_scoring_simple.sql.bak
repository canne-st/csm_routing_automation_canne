-- Simplified Neediness Scoring Query that actually works
-- This pulls real data from available tables without complex CTEs

SELECT DISTINCT
    a.account_id,
    a.account_name,
    a.tenant_id,

    -- Health Score from customer history
    COALESCE(h.core_health_score, 70) as health_score,
    COALESCE(h.core_health_score_color, 'Yellow') as health_segment,

    -- Revenue (simplified - you may need to adjust based on actual table structure)
    COALESCE(a.arr_total, 100000) as revenue,

    -- Segment and Level
    COALESCE(
        CASE
            WHEN a.market_category = 'Residential' THEN 'Residential'
            WHEN a.market_category = 'Commercial' THEN 'Commercial'
            ELSE 'Residential'
        END, 'Residential'
    ) as segment,

    COALESCE(
        CASE
            WHEN a.account_level IN ('Enterprise', 'Strategic') THEN 'Enterprise'
            WHEN a.account_level IN ('Corporate', 'MidMarket') THEN 'Corporate'
            ELSE 'Corporate'
        END, 'Corporate'
    ) as account_level,

    -- Industry
    COALESCE(a.industry_new, 'Roofing') as industry,

    -- TAD Score (simplified - not available in these tables)
    0 as tad_score,

    -- Tech Count (simplified)
    5 as tech_count,

    -- Calculate neediness score based on health and revenue
    CASE
        WHEN h.core_health_score_color = 'Red' THEN
            CASE
                WHEN COALESCE(a.arr_total, 0) > 500000 THEN 10
                WHEN COALESCE(a.arr_total, 0) > 100000 THEN 9
                ELSE 8
            END
        WHEN h.core_health_score_color = 'Yellow' THEN
            CASE
                WHEN COALESCE(a.arr_total, 0) > 500000 THEN 7
                WHEN COALESCE(a.arr_total, 0) > 100000 THEN 6
                ELSE 5
            END
        WHEN h.core_health_score_color = 'Green' THEN
            CASE
                WHEN COALESCE(a.arr_total, 0) > 500000 THEN 4
                WHEN COALESCE(a.arr_total, 0) > 100000 THEN 3
                ELSE 2
            END
        ELSE 5  -- Default
    END as neediness_score,

    -- Neediness Category
    CASE
        WHEN h.core_health_score_color = 'Red' THEN 'High'
        WHEN h.core_health_score_color = 'Yellow' THEN 'Medium'
        WHEN h.core_health_score_color = 'Green' THEN 'Low'
        ELSE 'Medium'
    END as neediness_category,

    -- Additional useful fields
    a.responsible_csm_c as responsible_csm,
    a.ultimate_parent_account_c,
    a.ultimate_parent_account_name,
    COALESCE(h.churn_stage, 'Not at risk') as churn_stage,
    COALESCE(a.timezone, 'US/Pacific') as timezone,

    -- Parent account flag
    CASE
        WHEN a.account_id IN (
            SELECT DISTINCT ultimate_parent_account_c
            FROM DSV_WAREHOUSE.PUBLIC.VW_SALESFORCE_ACCOUNT
        ) THEN 1
        ELSE 0
    END as is_parent_account,

    -- Related tenants count
    COALESCE(
        (SELECT COUNT(DISTINCT tenant_id)
         FROM DSV_WAREHOUSE.PUBLIC.VW_SALESFORCE_ACCOUNT sa
         WHERE sa.ultimate_parent_account_c = a.ultimate_parent_account_c
         GROUP BY ultimate_parent_account_c),
        0
    ) as related_tenants

FROM DSV_WAREHOUSE.PUBLIC.VW_SALESFORCE_ACCOUNT a

LEFT JOIN (
    SELECT
        account_id,
        core_health_score,
        core_health_score_color,
        churn_stage,
        ROW_NUMBER() OVER(PARTITION BY account_id ORDER BY calendar_date DESC) as rn
    FROM DSV_WAREHOUSE.POST_SALES.VW_CUSTOMER_HISTORY_DAILY
    WHERE is_current = TRUE
) h ON a.account_id = h.account_id AND h.rn = 1

WHERE 1=1
    AND a.account_id IS NOT NULL